---
date: 2024-12-04
category:
  - 数据库
tag:
  - MySQL
  - 索引
excerpt: 索引创建与使用的注意事项
order: 99
---

# 索引创建建议

## 为合适的字段创建索引

- 不为 NULL 的字段
- 被作为条件查询的字段
- 频繁用于查询、排序、连接、分组的字段

## 考虑列的基数

列的基数（Cardinality）指的是 **某一列中不重复数据的个数**，在记录行数一定的情况下，列的基数越大，该列中的值越分散，列的基数越小，该列中的值越集中

```sql
1、2、3、4、5、1、2
# 基数为 5

1、2、1、1、2、1、2
# 基数为 2
```

- 基数是 MySQL 通过采样估算出来的值，并不是一个精确的值

列中的重复值过多，在使用二分法查询时，可能还需要大量重复的数据进行遍历，才能找到所需的数据。甚至优化器如果发现某个值出现的概率占比很高（一般为 30%）会忽略索引，直接采用全表扫描

最好为那些列的基数大的列建立索引，为基数太小列的建立索引效果可能不好

## 索引字符串值的前缀

我们在 MySQL 中常用 UTF8 字符集去存储字符串，编码一个字符需要占用 1 ~ 3 个字节。如果字符串很长，那存储一个字符串就需要占用很大的存储空间，建立索引时占用的空间也很大，做字符串比较也会占用更多的时间

针对字符串的索引，可以只对字符串的前几个字符进行索引，这样在查找记录时虽然不能精确的定位到记录的位置，但是能定位到相应前缀所在的位置，然后根据前缀相同的记录的主键值回表查询完整的字符串值，再对比就好了

- 缺点是无法使用前缀索引做 `ORDER BY` 和 `GROUP BY` 操作，也无法使用前缀索引进行索引覆盖

```sql
CREATE TABLE person_info(
    name VARCHAR(100) NOT NULL,
    birthday DATE NOT NULL,
    phone_number CHAR(11) NOT NULL,
    country varchar(100) NOT NULL,
    KEY idx_name_birthday_phone_number (name(10), birthday, phone_number)
);    
```

`name(10)` 就表示在建立的 B+ 树索引中只保留记录的前 10 个字符

## 避免重复冗余的索引

冗余和重复索引，只会增加维护的成本，并不会对搜索有什么好处

## 尽可能考虑组合索引

索引是需要占用磁盘空间的，如果一个表的索引过多，占用的空间也是很多的

如果使用联合索引，多个字段在一个索引上，那么将会节约很大磁盘空间，且修改数据的操作效率也会提升

创建多个单列索引，在大部分情况下并不能提高查询性能。MySQL 引入了索引合并的策略，使用多个索引时，会对这些索引进行扫描，并将结果进行合并，会在算法的缓存、排序和合并操作上耗费大量 CPU 和内存资源

## 不要在频繁更新的列上创建索引

虽然索引能带来查询上的效率，但是维护索引的成本也是不小的

## 使用 `EXPLAIN` 分析语句

使用 `EXPLAIN` 分析语句，查看语句是否走了索引，帮助我们更好的创建索引

## 参考

- [MySQL 是怎样运行的：从根儿上理解 MySQL](https://juejin.cn/book/6844733769996304392)
- 《高性能MySQL（第4版）》
- [MySQL高性能优化规范建议总结](https://javaguide.cn/database/mysql/mysql-high-performance-optimization-specification-recommendations.html)
- [关于mysql索引基数的概念](https://blog.csdn.net/tiansidehao/article/details/78931765)
- [谈谈MySQL的基数统计](https://www.cnblogs.com/ZhuChangwu/p/13954817.html)
