---
date: 2024-11-21
category:
  - 数据库
tag:
  - Redis
excerpt: Redis 常见的阻塞原因
order: 99
---

# 阻塞点

## 集合全量查询和聚合操作

Redis 针对命令操作使用的是单线程，如果执行的命令操作过于耗时就会阻塞其他命令的执行，所以尽量不要执行 `O(N)` 级别的命令，或者使用 `scan` 命令分批读取数据

## bigkey 的删除与清空数据库

删除操作的本质是要释放占用的内存空间，应用程序在释放内存时，操作系统会将释放掉的内存插入到空闲内存块的链表，以便后续进行管理和再分配，这个操作不仅需要时间还会阻塞当前释放内存的应用

如果一下子释放了大量内存，空闲内存块链表操作时间就会增加，相应的就很容易造成 Redis 的阻塞

所以应该避免频繁删除键值对，可以采用分批删除和异步删除

- 分批删除：由开发者自己实现
- 异步删除：Redis 在 4.0 版本之后，新增了 **lazyfree** 线程，用来异步释放 Redis 内存
  - lazyfree 会根据具体命令的损耗来选择立即处理还是延迟处理

## 使用 `save` 命令创建 RDB 文件

`save` 会阻塞主线程，应使用 `bgsave`

## 加载 RDB

加载 RDB 文件时主线程是阻塞的

## AOF 记录

AOF 是在执行完命令后才会记录日志，虽然不会阻塞当前的写操作命令的执行，但会给下一条命令带来阻塞的风险，因为将命令写入到日志的这个操作也是在主进程完成的

## AOF 刷盘

AOF 默认会每秒将日志同步一次，虽然也是交由后台线程进行的，但线程调用 fsync 函数同步 AOF 文件时，需要等待，直到写入完成。当磁盘压力太大的时候，会导致 fsync 操作发生阻塞，主线程调用 write 函数时也会被阻塞，fsync 完成后，主线程执行 write 才能成功返回

## 参考

- [Redis 核心技术与实战](https://time.geekbang.org/column/intro/329)
- [Redis常见阻塞原因总结](https://javaguide.cn/database/redis/redis-common-blocking-problems-summary.html)
