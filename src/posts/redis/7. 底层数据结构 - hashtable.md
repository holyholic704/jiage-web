---
date: 2024-11-22
category:
  - 数据库
tag:
  - Redis
excerpt: 哈希表的实现原理，如何处理哈希冲突，rehash 是什么
order: 7
---

# 哈希表（hashtable）

hash 和 set 都使用了哈希表作为底层实现

- 当超过 listpack 的限制时，hash 才会使用哈希表作为内部实现
  - 元素数量超过 `hash-max-listpack-entries`，默认值为 512
  - 或元素大小超过 `hash-max-listpack-value`，默认值为 64 字节
- 当超过 listpack 的限制时，set 才会使用哈希表作为内部实现
  - 元素数量超过 `set-max-listpack-entries`，默认值为 128
  - 或元素大小超过 `set-max-listpack-entries`，默认值为 64 字节

## 哈希表的结构设计

```c
struct dict {
    dictType *type;

    dictEntry **ht_table[2];
    unsigned long ht_used[2];

    long rehashidx;
    int16_t pauserehash;
    signed char ht_size_exp[2];
    void *metadata[];
};

struct dictEntry {
    void *key;
    union {
        void *val;
        uint64_t u64;
        int64_t s64;
        double d;
    } v;
    struct dictEntry *next;
    void *metadata[];
};
```

## 哈希冲突

Redis 使用了 **链地址法 + 再哈希法** 来解决哈希冲突。Redis 会先将哈希冲突的元素加入到链表中，当链表中的元素越来越多时，查询性能降低，则会使用 rehash 法，对哈希表的大小进行扩展

### rehash

Redis 在 dict 结构体中定义了两个哈希表。正常情况下插入的元素都会写入到哈希表 1，此时的哈希表 2 并没有被分配空间，当链地址法的性能下降时，则会触发 rehash 操作

1. 给哈希表 2 分配空间，一般会比哈希表 1 大 2 倍
2. 将哈希表 1 的数据迁移到哈希表 2 中
3. 迁移完成后，哈希表 1 的空间会被释放，并把哈希表 2 设置为哈希表 1，然后在哈希表 2 新创建一个空白的哈希表，为下次 rehash 做准备

![](.\md.assets\rehash.png)

<small>[为了拿捏 Redis 数据结构，我画了 40 张图（完整版） - rehash](https://mp.weixin.qq.com/s?__biz=MzUxODAzNDg4NQ==&mid=2247501112&idx=1&sn=e42b6c61c6747e2c2f3b890ab4e4b844&chksm=f98d8192cefa0884606c5284499d76eeb3966ac2d3de9fbc4a405448313dcf79eb41b7c9501e&scene=178&cur_album_id=1790401816640225283#rd)</small>

### 渐进式 rehash

当哈希表中数据量很大时，在迁移的过程中涉及了大量的数据拷贝，可能会对 Redis 造成阻塞，影响性能。为了避免此类问题，Redis 使用了渐进式 rehash，即将数据的迁移的工作不再是一次性迁移完成，而是分多次迁移

1. 先给哈希表 2 分配空间
2. 在 rehash 进行期间，每次对哈希表元素进行操作时，Redis 除了会执行对应的操作之外，还会顺序的将哈希表 1 中索引位置上的所有键值对迁移到哈希表 2 上
3. 随着处理客户端发起的哈希表操作请求数量越多，最终在某个时间段内，会把哈希表 1 的所有键值对迁移到哈希表 2，从而完成 rehash 操作

在渐进式 rehash 进行期间，新增的键值对会被保存到哈希表 2 里面，而哈希表 1 则不再进行任何添加操作，这样保证了哈希表 1 的键值对数量只会减少，随着 rehash 操作的完成，最终哈希表 1 就会变成空表

### rehash 的触发条件

rehash 的触发条件跟负载因子（load factor）有关，`负载因子 = 哈希表已保存的节点数 / 哈希表大小`

- 当负载因子大于等于 1 ，并且 Redis 没有在执行 `bgsave` 命令或者 `bgrewiteaof` 命令，也就是没有执行 RDB 快照或没有进行 AOF 重写的时候，才会进行 rehash 操作
- 当负载因子大于等于 5 时，此时说明哈希冲突非常严重了，不管有没有在执行 RDB 快照或 AOF 重写，都会强制进行 rehash 操作

## 参考

- [为了拿捏 Redis 数据结构，我画了 40 张图（完整版）](https://mp.weixin.qq.com/s?__biz=MzUxODAzNDg4NQ==&mid=2247501112&idx=1&sn=e42b6c61c6747e2c2f3b890ab4e4b844&chksm=f98d8192cefa0884606c5284499d76eeb3966ac2d3de9fbc4a405448313dcf79eb41b7c9501e&scene=178&cur_album_id=1790401816640225283#rd)
- [分类：Redis - Error's Blog](https://zygzyg.cloud/categories/redis)
