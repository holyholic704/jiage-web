---
date: 2024-07-18
category:
  - JAVA
tag:
  - JVM
excerpt: 并发编程三大特性：原子性、可见性与有序性
order: 16
---

# 并发编程三大特性

## 原子性（Atomicity）

一个操作或者多个操作要么全部执行且执行的过程不会被任何因素打断，要么都不执行

由 JMM 来直接保证的原子性变量操作包括 `read`、`load`、`assign`、`use`、`store`、`write`，可以大致的认为 **对于基本数据类型的读写都是具备原子性的**

如果应用场景需要一个更大范围的原子性保证，JMM 还提供了 `lock` 和 `unlock` 操作来满足这种需求，尽管虚拟机未把 `lock` 和 `unlock` 操作直接开放给用户使用，但是却提供了更高层次的字节码指令 `monitorenter` 和 `monitorexit` 来隐式地使用这两个操作。这两个字节码指令反映到 Java 代码中就是同步块，`synchronized` 关键字，因此在 `synchronized` 块之间的操作也具备原子性

## 可见性（Visibility）

当一个线程修改了共享变量的值时，其他线程能够立即得知这个修改

JMM 通过在变量修改后将新值同步回主内存，在变量读取前从主内存刷新变量值这种依赖主内存作为传递媒介的方式来实现可见性的，无论是普通变量还是 `volatile` 变量都是如此

普通变量与 `volatile` 变量的区别是，`volatile` 的特殊规则保证了新值能立即同步到主内存，以及每次使用前立即从主内存刷新。因此可以说 `volatile` 保证了多线程操作时变量的可见性，而普通变量则不能保证这一点

除了 `volatile` 之外，Java 还有两个关键字能实现可见性，它们是 `synchronized` 和 `final`

- `synchronized`：通过 `unlock` 操作获得，对一个变量执行 `unlock` 操作之前，必须先把此变量同步回主内存中（执行 `store`、`write` 操作）
- `final`：被 `final` 修饰的字段在构造器中一旦被初始化完成，且没有对象逸出（对象未初始化完成就可以被别的线程使用），那么对于其他线程都是可见的

## 有序性（Ordering）

- 如果 **在本线程内观察，所有的操作都是有序的**，指线程内表现为串行的语义（As-If-Serial）
- 如果 **在一个线程中观察另一个线程，所有的操作都是无序的**，指指令重排序现象和工作内存与主内存同步延迟现象

Java 语言提供了 `volatile` 和 `synchronized` 两个关键字来保证线程之间操作的有序性

- `volatile`：关键字本身就包含了禁止指令重排序的语义
- `synchronized`：通过一个变量在同一个时刻只允许一条线程对其进行 `lock` 操作这条规则获得的，这个规则决定了持有同一个锁的两个同步块只能串行地进入

## 参考

- 深入理解Java虚拟机（第3版）
